<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MFWOA - Benchmark Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .container-custom { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header-bar { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .header-bar h1 { margin: 0; font-size: 1.8rem; font-weight: 700; }
    .algo-badge { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 12px; 
      font-weight: 600; 
      font-size: 0.75rem; 
      margin-left: 8px;
      vertical-align: middle;
    }
    .algo-badge-multitask { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
    .multitask-group-header { 
      background: #f0f7f0; 
      padding: 12px 15px; 
      border-left: 4px solid #27ae60; 
      margin-bottom: 15px; 
      border-radius: 4px; 
      font-weight: 600; 
      color: #1b5e20;
    }
    .multitask-group-title { font-size: 0.95rem; }
    .multitask-group-desc { font-size: 0.8rem; color: #666; font-weight: 400; margin-top: 4px; }
    .section-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: #2c3e50; }
    .info-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .info-box { flex: 0 0 auto; text-align: center; }
    .info-box img { max-width: 200px; max-height: 150px; border-radius: 6px; border: 1px solid #ddd; }
    .info-box label { display: block; margin-top: 8px; font-weight: 600; font-size: 0.9rem; color: #333; }
    .grid-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .result-card { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0; transition: all 0.2s; }
    .result-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); transform: translateY(-2px); }
    .result-card img { width: 100%; height: 140px; object-fit: cover; background: #f0f0f0; }
    .result-card-footer { padding: 12px; }
    .result-algo { font-weight: 700; font-size: 0.95rem; color: #2c3e50; margin-bottom: 8px; }
    .result-metrics { font-size: 0.8rem; color: #666; line-height: 1.6; }
    .result-metrics-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .metrics-table { font-size: 0.9rem; }
    .metrics-table thead { background: #f8f9fa; }
    .metrics-table td { padding: 10px 8px; }
    .download-btn { display: inline-block; margin-top: 12px; }
    .btn-primary-custom { background: #27ae60; border: none; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; cursor: pointer; font-size: 0.85rem; transition: background 0.3s; }
    .btn-primary-custom:hover { background: #229954; color: white; }
    .back-btn { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container-custom">
    <!-- Header -->
    <div class="header-bar">
      <h1>üî¨ Benchmark Results</h1>
    </div>

    <!-- Histogram + Info -->
    <div class="section-card">
      <div class="section-title">Histogram + Thresholds</div>
      <div class="info-row">
        {% if hist_thresh_url %}
          <img src="{{ hist_thresh_url }}" alt="Histogram + Thresholds" style="max-width: 100%; height: auto; border-radius: 6px;">
        {% else %}
          <p style="color: #999;">Histogram not available</p>
        {% endif %}
      </div>
      {% if hist_thresh_url %}
        <a href="{{ hist_thresh_url }}" download class="btn-primary-custom">üì• Download Histogram Image</a>
      {% endif %}
    </div>

    <!-- Advanced Visualization Plots -->
    

    <!-- Segmentation Results Grid -->
    <div class="section-card">
      <div class="section-title">Segmentation Results by Algorithm</div>
      
      <!-- Group header for MFWOA Multitask (if exists) -->
      {% set has_multitask = namespace(value=false) %}
      {% for e in export_entries %}
        {% if 'multitask' in e.algo.lower() %}
          {% if not has_multitask.value %}
            <div class="multitask-group-header">
              <div class="multitask-group-title">üîó MFWOA Multitask - Multiple K Values</div>
              <div class="multitask-group-desc">Knowledge transfer across K=[2..K] optimization</div>
            </div>
            {% set has_multitask.value = true %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      <div class="grid-results">
        {% for e in export_entries %}
          <div class="result-card">
            {% if e.seg_url %}
              <img src="{{ e.seg_url }}" alt="{{ e.algo }}" class="result-image">
            {% else %}
              <div style="width: 100%; height: 140px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">No image</div>
            {% endif %}
            <div class="result-card-footer">
              <div class="result-algo">
                {{ e.algo }}
                {% if 'multitask' in e.algo.lower() %}
                  <span class="algo-badge algo-badge-multitask">üîó Multi-K</span>
                {% endif %}
              </div>
              {% for row in df_rows %}
                {% if row.algo == e.algo %}
                  <div class="result-metrics">
                    <div class="result-metrics-row"><span>FE:</span><strong>{{ "%.4f"|format(row.fe) if row.fe else "N/A" }}</strong></div>
                    <div class="result-metrics-row"><span>Time:</span><strong>{{ row.time }}s</strong></div>
                    <div class="result-metrics-row"><span>PSNR:</span><strong>{{ "%.2f"|format(row.psnr) if row.psnr else "N/A" }}</strong></div>
                    <div class="result-metrics-row"><span>SSIM:</span><strong>{{ "%.3f"|format(row.ssim) if row.ssim else "N/A" }}</strong></div>
                    <div class="result-metrics-row"><span>DICE:</span><strong>{{ "%.3f"|format(row.dice) if row.dice else "N/A" }}</strong></div>
                  </div>
                  {% if e.seg_url %}
                    <a href="{{ e.seg_url }}" download class="btn-primary-custom download-btn">üì• Download</a>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Metrics Table -->
    <div class="section-card">
      <div class="section-title">Full Metrics Table</div>
      
      <!-- Group header for MFWOA Multitask in table (if exists) -->
      {% set has_multitask = false %}
      {% for row in df_rows %}
        {% if 'multitask' in row['algo'] %}
          {% set has_multitask = true %}
        {% endif %}
      {% endfor %}
      
      {% if has_multitask %}
        <div class="multitask-group-header" style="margin-bottom: 15px;">
          <div class="multitask-group-title">üîó MFWOA Multitask Results - K Comparison</div>
          <div class="multitask-group-desc">Each row represents one K value within the multitask optimization</div>
        </div>
      {% endif %}
      
      <div style="overflow-x: auto;">
        <table class="table table-striped metrics-table">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Thresholds</th>
              <th>FE</th>
              <th>Time (s)</th>
              <th>PSNR</th>
              <th>SSIM</th>
              <th>DICE</th>
            </tr>
          </thead>
          <tbody>
            {% for row in df_rows %}
              <tr>
                <td>
                  <strong>{{ row.algo }}</strong>
                  {% if 'multitask' in row.algo.lower() %}
                    <span class="algo-badge algo-badge-multitask">üîó Multi-K</span>
                  {% endif %}
                </td>
                <td><code style="font-size: 0.85rem;">{{ row.thresholds }}</code></td>
                <td>{{ "%.6f"|format(row.fe) if row.fe else "‚Äî" }}</td>
                <td>{{ "%.4f"|format(row.time) if row.time else "‚Äî" }}</td>
                <td>{{ "%.2f"|format(row.psnr) if row.psnr else "‚Äî" }}</td>
                <td>{{ "%.4f"|format(row.ssim) if row.ssim else "‚Äî" }}</td>
                <td>{{ "%.3f"|format(row.dice) if row.dice is not none else "‚Äî" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="margin-top: 15px; padding: 12px; background: #f9f9f9; border-left: 4px solid #27ae60; border-radius: 4px; font-size: 0.9rem; color: #555;">
        <strong>üìã Note:</strong> <strong>FE</strong> = Fuzzy Entropy (optimization target, higher is better). <strong>PSNR/SSIM</strong> = image reconstruction quality. <strong>DICE</strong> = segmentation overlap vs ground-truth (shown if GT provided).
        <details style="margin-top: 10px;">
          <summary style="cursor: pointer; font-weight: 600; color: #27ae60;">‚ùì Why is FE high but PSNR/SSIM low?</summary>
          <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; font-size: 0.85rem;">
            <p><strong>This is normal.</strong> FE and PSNR/SSIM optimize <strong>different objectives</strong>:</p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li><strong>FE (Fuzzy Entropy)</strong>: Maximizes classification fuzziness (soft boundaries). Higher FE = more uncertain class assignments.</li>
              <li><strong>PSNR/SSIM</strong>: Measures reconstruction accuracy (how well segmented image matches original). Lower values mean thresholds create larger class regions.</li>
            </ul>
            <p><strong>Solution:</strong> Choose a membership function or optimizer based on your goal:</p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>For <strong>accurate reconstruction</strong>: Use <code>triangular</code> membership (sharper boundaries)</li>
              <li>For <strong>fuzzy classification</strong>: Use <code>gaussian</code> membership (softer boundaries)</li>
              <li>For <strong>both</strong>: Compare all results and pick one that balances your needs</li>
            </ul>
          </div>
        </details>
      </div>
      {% if csv_data_url %}
        <a href="{{ csv_data_url }}" download class="btn-primary-custom" style="margin-top: 12px;">üìä Download CSV</a>
      {% endif %}
    </div>

    <!-- Best Results Comparison -->
    <div class="section-card">
      <div class="section-title">üìä Best Results Comparison</div>
      <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Top performers ranked by FE, PSNR, and SSIM:</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- Best by FE -->
        {% if best_by_fe %}
        <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; background: #fffbf0;">
          <div style="text-align: center; font-weight: 700; color: #f39c12; margin-bottom: 12px;">üèÜ Best by FE</div>
          {% for e in export_entries %}
            {% if e.algo == best_by_fe.algo %}
              <img src="{{ e.seg_url }}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">
            {% endif %}
          {% endfor %}
          <div style="font-size: 0.85rem; color: #333;">
            <div><strong>{{ best_by_fe.algo }}</strong></div>
            <div>FE: <strong style="color: #f39c12;">{{ "%.6f"|format(best_by_fe.fe) if best_by_fe.fe else "N/A" }}</strong></div>
            <div>PSNR: {{ "%.2f"|format(best_by_fe.psnr) if best_by_fe.psnr else "‚Äî" }}</div>
            <div>SSIM: {{ "%.4f"|format(best_by_fe.ssim) if best_by_fe.ssim else "‚Äî" }}</div>
            <div style="font-size: 0.75rem; color: #999; margin-top: 8px;">T: {{ best_by_fe.thresholds }}</div>
          </div>
        </div>
        {% endif %}

        <!-- Best by PSNR -->
        {% if best_by_psnr %}
        <div style="border: 2px solid #27ae60; border-radius: 8px; padding: 15px; background: #f0fef5;">
          <div style="text-align: center; font-weight: 700; color: #27ae60; margin-bottom: 12px;">üèÜ Best by PSNR</div>
          {% for e in export_entries %}
            {% if e.algo == best_by_psnr.algo %}
              <img src="{{ e.seg_url }}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">
            {% endif %}
          {% endfor %}
          <div style="font-size: 0.85rem; color: #333;">
            <div><strong>{{ best_by_psnr.algo }}</strong></div>
            <div>PSNR: <strong style="color: #27ae60;">{{ "%.2f"|format(best_by_psnr.psnr) }}</strong></div>
            <div>FE: {{ "%.4f"|format(best_by_psnr.fe) if best_by_psnr.fe else "‚Äî" }}</div>
            <div>SSIM: {{ "%.4f"|format(best_by_psnr.ssim) if best_by_psnr.ssim else "‚Äî" }}</div>
            <div style="font-size: 0.75rem; color: #999; margin-top: 8px;">T: {{ best_by_psnr.thresholds }}</div>
          </div>
        </div>
        {% endif %}

        <!-- Best by SSIM -->
        {% if best_by_ssim %}
        <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; background: #f0f9ff;">
          <div style="text-align: center; font-weight: 700; color: #3498db; margin-bottom: 12px;">üèÜ Best by SSIM</div>
          {% for e in export_entries %}
            {% if e.algo == best_by_ssim.algo %}
              <img src="{{ e.seg_url }}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">
            {% endif %}
          {% endfor %}
          <div style="font-size: 0.85rem; color: #333;">
            <div><strong>{{ best_by_ssim.algo }}</strong></div>
            <div>SSIM: <strong style="color: #3498db;">{{ "%.4f"|format(best_by_ssim.ssim) }}</strong></div>
            <div>FE: {{ "%.6f"|format(best_by_ssim.fe) if best_by_ssim.fe else "‚Äî" }}</div>
            <div>PSNR: {{ "%.2f"|format(best_by_ssim.psnr) if best_by_ssim.psnr else "‚Äî" }}</div>
            <div style="font-size: 0.75rem; color: #999; margin-top: 8px;">T: {{ best_by_ssim.thresholds }}</div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
      <div class="section-title">Segmentation Comparison (All Algorithms)</div>
      <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Segmentation masks colored by class for visual comparison:</p>
      {% if df_rows and df_rows[0].dice is none %}
        <div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 15px; font-size: 0.9rem; color: #856404;">
          <strong>‚ÑπÔ∏è Note:</strong> Ground-truth (GT) was not provided. DICE scores are not computed. To enable DICE evaluation, upload a ground-truth mask image in the home page form.
        </div>
      {% endif %}
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        {% for e in export_entries %}
          <div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white;">
            {% if e.seg_url %}
              <img src="{{ e.seg_url }}" style="width: 100%; height: 200px; object-fit: cover; background: #f0f0f0;" alt="{{ e.algo }}">
            {% endif %}
            <div style="padding: 12px; text-align: center;">
              <div style="font-weight: 700; color: #2c3e50; margin-bottom: 8px;">{{ e.algo }}</div>
              {% for row in df_rows %}
                {% if row.algo == e.algo %}
                  <div style="font-size: 0.8rem; color: #666;">
                    <div>Thresholds: <code>{{ row.thresholds }}</code></div>
                    <div>FE: <strong>{{ "%.4f"|format(row.fe) if row.fe else "N/A" }}</strong></div>
                  </div>
                {% endif %}
              {% endfor %}
              {% if e.seg_url %}
                <a href="{{ e.seg_url }}" download style="display: inline-block; margin-top: 10px; font-size: 0.8rem; padding: 6px 12px; background: #3498db; color: white; border-radius: 4px; text-decoration: none;">‚¨á Download</a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Back Button -->
    <div class="back-btn">
      <a href="{{ url_for('index') }}" class="btn-primary-custom" style="background: #95a5a6;">‚Üê Back to Home</a>
    </div>
  </div>
</body>
</html>
