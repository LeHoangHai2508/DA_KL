<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MFWOA Segmentation Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { display: flex; height: 100vh; background: #f5f5f5; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .sidebar { width: 320px; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
    .sidebar h3 { font-size: 1.2rem; margin-bottom: 1rem; font-weight: 600; }
    .main-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .top-bar { background: white; padding: 15px 20px; border-bottom: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .top-bar h2 { margin: 0; font-size: 1.4rem; font-weight: 600; }
    .preview-area { display: flex; gap: 15px; padding: 15px; background: white; margin: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .preview-box { flex: 0 0 auto; text-align: center; }
    .preview-box img { max-width: 180px; max-height: 180px; border-radius: 4px; border: 1px solid #ddd; }
    .preview-box label { display: block; font-weight: 600; margin-top: 8px; font-size: 0.9rem; color: #333; }
    .controls-group { margin-bottom: 1.2rem; }
    .controls-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem; }
    .controls-group input[type="text"], .controls-group input[type="file"], .controls-group select { width: 100%; padding: 8px; margin-bottom: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #34495e; color: white; box-sizing: border-box; }
    .controls-group input[type="range"] { width: 100%; cursor: pointer; }
    .controls-group input::placeholder { color: #bbb; }
    .algo-checkbox { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .algo-checkbox input { margin-right: 8px; width: 16px; height: 16px; cursor: pointer; }
    .algo-checkbox label { margin: 0; flex: 1; cursor: pointer; font-size: 0.95rem; }
    .btn-run { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background 0.3s; margin-top: 0.5rem; }
    .btn-run:hover { background: #229954; }
    .content-area { flex: 1; overflow-y: auto; padding: 15px; background: #fafafa; }
    .grid-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .result-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
    .result-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .result-card img { width: 100%; height: 150px; object-fit: cover; }
    .result-card-body { padding: 12px; }
    .result-card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 8px; }
    .result-metrics { font-size: 0.85rem; color: #666; line-height: 1.4; }
    .result-metrics div { display: flex; justify-content: space-between; }
    .histogram-section { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .histogram-section h4 { margin: 0 0 15px 0; font-weight: 600; }
    .histogram-img { max-width: 100%; height: auto; border-radius: 4px; }
    @media (max-width: 768px) { .sidebar { width: 100%; max-height: 40vh; overflow-x: auto; } .main-panel { flex: 1; } }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>‚öôÔ∏è MFWOA Config</h3>
    
    <form action="{{ url_for('compute') }}" method="post" enctype="multipart/form-data" id="form">
      <!-- Image Upload -->
      <div class="controls-group">
        <label class="form-label">üì∑ Open Image(s)</label>
        <input type="file" name="image" accept="image/*" required style="color: #bbb;">
      </div>

      <!-- Ground Truth -->
      <div class="controls-group">
        <label class="form-label">üéØ Ground Truth (optional)</label>
        <input type="file" name="gt" accept="image/*" style="color: #bbb;">
      </div>

      <!-- K (Thresholds) -->
      <div class="controls-group">
        <label>S·ªë ng∆∞·ª°ng (K)</label>
        <input type="number" name="n_thresholds" min="1" max="10" value="4" required>
      </div>

      <!-- Algorithm Selection -->
      <div class="controls-group">
        <label>Ch·ªçn thu·∫≠t to√°n</label>
        <div class="algo-checkbox">
          <input type="checkbox" name="algos" value="otsu" id="algo_otsu" checked>
          <label for="algo_otsu">Otsu</label>
        </div>
        <div class="algo-checkbox">
          <input type="checkbox" name="algos" value="mfwoa" id="algo_mfwoa" checked>
          <label for="algo_mfwoa">MFWOA</label>
        </div>
        <div class="algo-checkbox">
          <input type="checkbox" name="algos" value="woa" id="algo_woa" checked>
          <label for="algo_woa">WOA</label>
        </div>
        <div class="algo-checkbox">
          <input type="checkbox" name="algos" value="pso" id="algo_pso">
          <label for="algo_pso">PSO</label>
        </div>
      </div>

      <!-- MFWOA Mode Selection -->
      <div class="controls-group">
        <label>üîó MFWOA Mode (n·∫øu ch·ªçn MFWOA)</label>
        <div class="algo-checkbox">
          <input type="radio" name="optimization_mode" value="single" id="mode_single" checked>
          <label for="mode_single">Single-task (K c·ªë ƒë·ªãnh)</label>
        </div>
        <div class="algo-checkbox">
          <input type="radio" name="optimization_mode" value="multitask" id="mode_multitask">
          <label for="mode_multitask">Multitask (MFWOA K=[2..K] + others single-task)</label>
        </div>
        <small style="color: #aaa; margin-top: 0.5rem; display: block;">
          ‚ÑπÔ∏è Single: T·∫•t c·∫£ algos ch·ªâ ch·∫°y 1 K c·ªë ƒë·ªãnh. Multitask: MFWOA t·ªëi ∆∞u ƒë·ªìng th·ªùi K=[2..K], sau ƒë√≥ Otsu/WOA/PSO ch·∫°y single-task v·ªõi K c·ªë ƒë·ªãnh.
        </small>
      </div>

      <!-- Optimizer Parameters -->
      <div class="controls-group">
        <label>pop: <span id="pop-display">30</span></label>
        <input type="range" name="pop_size" id="pop_size" min="4" max="100" value="30" step="1">
      </div>

      <div class="controls-group">
        <label>iters: <span id="iter-display">100</span> 
          <small id="iter-adaptive" style="color: #aaa; font-weight: normal;"></small>
        </label>
        <input type="range" name="opt_iters" id="opt_iters" min="10" max="500" value="100" step="10">
      </div>

      <!-- Membership -->
      <div class="controls-group">
        <label>Membership</label>
        <select name="membership">
          <option value="triangular" selected>triangular (recommended)</option>
          <!-- Gaussian membership disabled: causes inflated FE values due to overlap -->
        </select>
      </div>

      <!-- Benchmark -->
      <div class="controls-group">
        <div style="display: flex; align-items: center;">
          <input type="checkbox" name="benchmark" id="benchmark" style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
          <label for="benchmark" style="margin: 0; cursor: pointer; font-weight: 600;">Run Benchmark</label>
        </div>
      </div>

      <!-- Run Button -->
      <button type="submit" class="btn-run">‚ñ∂Ô∏è Run</button>
    </form>
  </div>

  <!-- Main Panel -->
  <div class="main-panel">
    <!-- Top Bar -->
    <div class="top-bar">
      <h2>üî¨ MFWOA Segmentation Demo</h2>
    </div>

    <!-- Preview Area -->
    <div class="preview-area">
      <div class="preview-box">
        <img id="preview_img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect fill='%23f0f0f0' width='180' height='180'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999' font-family='sans-serif' font-size='14'%3ENo Image%3C/text%3E%3C/svg%3E" alt="preview">
        <label>Input Image</label>
      </div>
      <div class="preview-box">
        <img id="hist_img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='120'%3E%3Crect fill='%23f0f0f0' width='300' height='120'/%3E%3C/svg%3E" alt="histogram" style="width: 350px; height: 120px;">
        <label>Histogram + Thresholds</label>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area" id="content">
      <p style="color: #999; text-align: center; padding: 50px 20px;">Upload an image and click Run to start segmentation.</p>
    </div>
  </div>

  <script>
    // Range sliders display and adaptive iterations based on K
    document.getElementById('pop_size').addEventListener('input', (e) => {
      document.getElementById('pop-display').textContent = e.target.value;
    });
    
    document.getElementById('opt_iters').addEventListener('input', (e) => {
      document.getElementById('iter-display').textContent = e.target.value;
      updateAdaptiveInfo();
    });
    
    // Update adaptive iterations message based on K - matches Python logic in app.py
    function updateAdaptiveInfo() {
      const kInput = document.querySelector('input[name="n_thresholds"]');
      const itersInput = document.getElementById('opt_iters');
      const adaptiveLabel = document.getElementById('iter-adaptive');
      
      if (!kInput || !itersInput) return;
      
      const K = parseInt(kInput.value) || 4;
      const iters = parseInt(itersInput.value) || 100;
      let actualIters = iters;
      
      // Match Python logic: K>=8: 25%, K>=6: 40%, K>=5: 60%
      if (K >= 8) {
        actualIters = Math.max(30, Math.floor(iters * 0.25));
      } else if (K >= 6) {
        actualIters = Math.max(50, Math.floor(iters * 0.4));
      } else if (K >= 5) {
        actualIters = Math.max(75, Math.floor(iters * 0.6));
      }
      
      if (K > 4) {
        adaptiveLabel.textContent = `(‚Üí ${actualIters} for K=${K})`;
      } else {
        adaptiveLabel.textContent = '';
      }
    }
    
    // Watch K changes
    document.querySelector('input[name="n_thresholds"]').addEventListener('change', updateAdaptiveInfo);
    document.querySelector('input[name="n_thresholds"]').addEventListener('input', updateAdaptiveInfo);

    // Image preview
    document.querySelector('input[type="file"][name="image"]').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById('preview_img').src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Form submit
    document.getElementById('form').addEventListener('submit', (e) => {
      e.preventDefault();
      // Submit normally to redirect to processing/result page
      e.target.submit();
    });
  </script>
</body>
</html>
